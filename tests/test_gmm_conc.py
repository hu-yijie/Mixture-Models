from Mixture_Models import *
from tests import utils


def init_GMM_Constrainted():
    return utils.init_MM(GMM_Constrainted,default_pinwheel_data,10,
    init_params_args={'num_components':3,'scale':0.5},
    expected={'log proportions': [ 0.66579325,  0.35763949, -0.77270015],
    'means': [[-0.00419192,  0.31066799],[-0.36004278,  0.13275579],[ 0.05427426,  0.00214572]],
    'sqrt_covs': np.eye(2)})

def check_mpkls(MM,params_store,expected):
    actual = []
    for params in params_store:
        kl_cov = []
        for log_proportion, mean, cov_sqrt in zip(*MM.unpack_params(params)):
            kl_cov.append(cov_sqrt.T @ cov_sqrt)
        actual.append(MM.print_mpkl(params['means'],kl_cov))
    utils.check_array_equal(actual,expected)

def test_gmm_conc_illustration():
    test_GMM, init_params = init_GMM_Constrainted()
    params_store = utils.check_fit(test_GMM,init_params,"grad_descent",{'learning_rate':0.0009,'mass':0.8,'maxiter':100},
    100,{'likelihood':[-720.8092616186832, -713.8910013012256, -702.195833872699, -688.2919666478814, -675.2823078440512, -666.503014618501, -664.031879949132, -666.0491930198806, -666.9097879692818, -663.5416942201682, -658.8410584727726, -656.1822817270356, -655.9076644742253, -656.728309097562, -657.4636940077587, -657.6045582599806, -657.2151833894802, -656.6469311666859, -656.2469514067093, -656.1509787800867, -656.2430409113254, -656.3005158643216, -656.1967074174463, -655.9754658780907, -655.7613378601483, -655.6368058913608, -655.6006199196472, -655.603129241011, -655.5977650846362, -655.5676268603831, -655.522341716755, -655.4799116729799, -655.4504396469137, -655.4311881007607, -655.4122925713626, -655.3856622584873, -655.3497202422616, -655.307994943531, -655.2647129438471, -655.2215623140509, -655.1773716498818, -655.1297376102461, -655.0767155302411, -655.0174292161701, -654.9516352237041, -654.878937531454, -654.7982877073644, -654.7079566009695, -654.6057669559474, -654.4892677029923, -654.3556685211792, -654.2015479016843, -654.0224424330945, -653.8123871302296, -653.5633697324236, -653.2645597007909, -652.9010970969642, -652.4521386299451, -651.887678231076, -651.1632743920534, -650.2110408595067, -648.9237315417922, -647.1257869477215, -644.5198338887747, -640.5901688360627, -634.4538784214908, -624.7894042555752, -610.705428117376, -595.8929753952141, -590.0503010612799, -585.8737207993381, -588.0738130399614, -592.5696408764354, -592.0752101465773, -588.1870615453905, -585.441273189029, -583.6621756210948, -582.6830779146201, -583.1128046980822, -583.1940824866161, -582.8444112664058, -582.4307430330487, -581.6988089488693, -581.2909943893961, -581.1848325806087, -581.0255378482976, -580.9109741159423, -580.7769545613996, -580.5963946983987, -580.4390352281251, -580.2387929945296, -580.0434847519355, -579.8865420223256, -579.7208986433076, -579.5622762620139, -579.3909736987075, -579.1837468251539, -578.9605669819441, -578.7249612076976, -578.4843451649748],
    'aic':[1463.6185232373664, 1449.7820026024513, 1426.391667745398, 1398.5839332957628, 1372.5646156881023, 1355.006029237002, 1350.063759898264, 1354.0983860397612, 1355.8195759385635, 1349.0833884403364, 1339.6821169455452, 1334.3645634540712, 1333.8153289484505, 1335.456618195124, 1336.9273880155174, 1337.2091165199613, 1336.4303667789604, 1335.2938623333719, 1334.4939028134186, 1334.3019575601734, 1334.4860818226507, 1334.6010317286432, 1334.3934148348926, 1333.9509317561815, 1333.5226757202965, 1333.2736117827217, 1333.2012398392944, 1333.206258482022, 1333.1955301692724, 1333.1352537207663, 1333.04468343351, 1332.9598233459599, 1332.9008792938273, 1332.8623762015213, 1332.8245851427253, 1332.7713245169746, 1332.6994404845232, 1332.615989887062, 1332.5294258876943, 1332.4431246281017, 1332.3547432997636, 1332.2594752204923, 1332.1534310604823, 1332.0348584323401, 1331.9032704474082, 1331.757875062908, 1331.5965754147287, 1331.415913201939, 1331.2115339118948, 1330.9785354059845, 1330.7113370423583, 1330.4030958033686, 1330.044884866189, 1329.6247742604592, 1329.126739464847, 1328.5291194015817, 1327.8021941939285, 1326.9042772598903, 1325.775356462152, 1324.3265487841068, 1322.4220817190135, 1319.8474630835844, 1316.251573895443, 1311.0396677775493, 1303.1803376721255, 1290.9077568429816, 1271.5788085111503, 1243.410856234752, 1213.7859507904282, 1202.1006021225598, 1193.7474415986762, 1198.1476260799227, 1207.1392817528708, 1206.1504202931546, 1198.374123090781, 1192.882546378058, 1189.3243512421896, 1187.3661558292401, 1188.2256093961644, 1188.3881649732323, 1187.6888225328116, 1186.8614860660973, 1185.3976178977387, 1184.5819887787923, 1184.3696651612174, 1184.0510756965953, 1183.8219482318846, 1183.5539091227993, 1183.1927893967975, 1182.8780704562503, 1182.4775859890592, 1182.086969503871, 1181.7730840446511, 1181.4417972866152, 1181.1245525240279, 1180.781947397415, 1180.3674936503078, 1179.9211339638882, 1179.4499224153951, 1178.9686903299496],
    'bic':[1504.3601304585845, 1490.5236098236694, 1467.1332749666162, 1439.325540516981, 1413.3062229093205, 1395.74763645822, 1390.805367119482, 1394.8399932609793, 1396.5611831597816, 1389.8249956615546, 1380.4237241667633, 1375.1061706752894, 1374.5569361696687, 1376.1982254163422, 1377.6689952367356, 1377.9507237411794, 1377.1719740001786, 1376.03546955459, 1375.2355100346367, 1375.0435647813915, 1375.2276890438688, 1375.3426389498613, 1375.1350220561108, 1374.6925389773996, 1374.2642829415147, 1374.0152190039398, 1373.9428470605126, 1373.94786570324, 1373.9371373904905, 1373.8768609419844, 1373.7862906547282, 1373.701430567178, 1373.6424865150454, 1373.6039834227395, 1373.5661923639434, 1373.5129317381927, 1373.4410477057413, 1373.35759710828, 1373.2710331089124, 1373.1847318493199, 1373.0963505209818, 1373.0010824417104, 1372.8950382817004, 1372.7764656535583, 1372.6448776686263, 1372.499482284126, 1372.3381826359469, 1372.1575204231572, 1371.953141133113, 1371.7201426272027, 1371.4529442635765, 1371.1447030245868, 1370.7864920874072, 1370.3663814816773, 1369.8683466860653, 1369.2707266227999, 1368.5438014151466, 1367.6458844811084, 1366.5169636833702, 1365.068156005325, 1363.1636889402316, 1360.5890703048026, 1356.9931811166612, 1351.7812749987675, 1343.9219448933436, 1331.6493640641997, 1312.3204157323685, 1284.15246345597, 1254.5275580116463, 1242.842209343778, 1234.4890488198944, 1238.8892333011408, 1247.880888974089, 1246.8920275143728, 1239.1157303119992, 1233.624153599276, 1230.0659584634077, 1228.1077630504583, 1228.9672166173825, 1229.1297721944504, 1228.4304297540298, 1227.6030932873155, 1226.1392251189568, 1225.3235960000104, 1225.1112723824356, 1224.7926829178134, 1224.5635554531027, 1224.2955163440174, 1223.9343966180156, 1223.6196776774684, 1223.2191932102774, 1222.828576725089, 1222.5146912658693, 1222.1834045078333, 1221.866159745246, 1221.5235546186332, 1221.109100871526, 1220.6627411851064, 1220.1915296366133, 1219.7102975511677]})
    check_mpkls(test_GMM,params_store,[0.0]*100)
    utils.check_labels(test_GMM,default_pinwheel_data,params_store,[1, 0, 1, 2, 0, 0, 0, 0, 2, 0, 0, 2, 1, 0, 2, 0, 0, 0, 2, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 2, 2,
       0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 2, 0, 0, 2, 0, 0, 2, 2, 2, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
       1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
       1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
       1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1,
       1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
       1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0])