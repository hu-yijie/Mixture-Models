from Mixture_Models import *
from tests import utils


def init_GMM():
    return utils.init_MM(GMM,default_pinwheel_data,10,
    init_params_args={'num_components':3,'scale':0.5},
    expected={'log proportions': [ 0.66579325,  0.35763949, -0.77270015],
    'means': [[-0.00419192,  0.31066799],[-0.36004278,  0.13275579],[ 0.05427426,  0.00214572]],
    'sqrt_covs': [np.eye(2),np.eye(2),np.eye(2)]})

def check_mpkls(MM,params_store,expected):
    actual = []
    for params in params_store:
        kl_cov = []
        for log_proportion, mean, cov_sqrt in zip(*MM.unpack_params(params)):
            kl_cov.append(cov_sqrt.T @ cov_sqrt)
        actual.append(MM.print_mpkl(params['means'],kl_cov))
    utils.check_array_equal(actual,expected)

def test_gmm_illustration():
    test_GMM, init_params = init_GMM()
    params_store = utils.check_fit(test_GMM,init_params,"grad_descent",{'learning_rate':0.0005,'mass':0.9,'maxiter':100},
    100,{'likelihood':[-720.8092616186832, -719.9324989689964, -718.274814939572, -715.9300034638668, -712.9900481929888, -709.5458269817977, -705.6880453853835, -701.5082241387773, -697.0995833835279, -692.557653132106, -687.9804054374334, -683.467660563424, -679.1194852214626, -675.0333048263767, -671.2995356451652, -667.9957548102311, -665.1797992207992, -662.8826958402399, -661.1028521459016, -659.8032389258503, -658.9131007549157, -658.3348876031123, -657.9557758247456, -657.6618055087696, -657.3518342045413, -656.9484866199953, -656.4040216179089, -655.7002839476835, -654.8433206006827, -653.8544379608578, -652.7600866545947, -651.5827966792071, -650.3345799798044, -649.0131686118611, -647.6005850730753, -646.0630742951746, -644.3513504892028, -642.4002714559439, -640.12727888677, -637.4291244751488, -634.176494153884, -630.2061599145472, -625.3104086368007, -619.2247622941566, -611.6214914638102, -602.1343359733473, -590.4502973454539, -576.5214283372425, -560.8763435657727, -545.7548815517194, -557.5787187864312, -552.9499535266336, -542.0578600300125, -538.7952832949006, -540.0509343382073, -540.1047083135685, -538.3920941446918, -534.537647432514, -525.1460662219934, -517.0542202917709, -526.1145493153922, -518.848930048831, -512.8972178891287, -514.439105208505, -515.9467825935965, -510.42814687646216, -506.3093379899209, -504.6531478482634, -503.71436357935886, -499.79813193959666, -496.7932233316701, -495.8327695607124, -493.04689889900874, -487.3812837574901, -480.8114423430239, -481.9367513458118, -474.17574082901194, -472.88078575050895, -469.2855044181586, -464.3911415254778, -464.12620068500365, -459.5986336992521, -463.210835853012, -467.0731693515859, -466.3786838127068, -464.6804267456888, -464.2275296339129, -460.8368360423058, -458.54663676806274, -459.7961376646298, -460.32717742927554, -460.4619067713055, -460.431358782867, -461.00300583656076, -460.31408472166686, -460.4857895176706, -459.6079258588801, -458.52859219602897, -458.0932767136611, -457.7627030996754],
    'aic':[1475.6185232373664, 1473.8649979379927, 1470.549629879144, 1465.8600069277336, 1459.9800963859775, 1453.0916539635955, 1445.376090770767, 1437.0164482775547, 1428.1991667670559, 1419.115306264212, 1409.9608108748669, 1400.935321126848, 1392.2389704429252, 1384.0666096527534, 1376.5990712903304, 1369.9915096204622, 1364.3595984415983, 1359.7653916804798, 1356.2057042918032, 1353.6064778517007, 1351.8262015098314, 1350.6697752062246, 1349.9115516494912, 1349.3236110175392, 1348.7036684090826, 1347.8969732399905, 1346.8080432358179, 1345.400567895367, 1343.6866412013653, 1341.7088759217156, 1339.5201733091894, 1337.1655933584143, 1334.6691599596088, 1332.0263372237223, 1329.2011701461506, 1326.1261485903492, 1322.7027009784056, 1318.8005429118878, 1314.25455777354, 1308.8582489502976, 1302.352988307768, 1294.4123198290945, 1284.6208172736015, 1272.4495245883131, 1257.2429829276205, 1238.2686719466947, 1214.9005946909078, 1187.042856674485, 1155.7526871315454, 1125.509763103439, 1149.1574375728624, 1139.8999070532673, 1118.115720060025, 1111.5905665898013, 1114.1018686764146, 1114.209416627137, 1110.7841882893836, 1103.075294865028, 1084.2921324439867, 1068.1084405835418, 1086.2290986307844, 1071.697860097662, 1059.7944357782574, 1062.87821041701, 1065.893565187193, 1054.8562937529243, 1046.6186759798418, 1043.3062956965268, 1041.4287271587177, 1033.5962638791934, 1027.5864466633402, 1025.665539121425, 1020.0937977980175, 1008.7625675149802, 995.6228846860478, 997.8735026916236, 982.3514816580239, 979.7615715010179, 972.5710088363172, 962.7822830509556, 962.2524013700073, 953.1972673985042, 960.421671706024, 968.1463387031718, 966.7573676254136, 963.3608534913776, 962.4550592678258, 955.6736720846116, 951.0932735361255, 953.5922753292596, 954.6543548585511, 954.923813542611, 954.862717565734, 956.0060116731215, 954.6281694433337, 954.9715790353412, 953.2158517177602, 951.0571843920579, 950.1865534273222, 949.5254061993508],
    'bic':[1538.5828253065217, 1536.829300007148, 1533.5139319482994, 1528.824308996889, 1522.9443984551328, 1516.0559560327508, 1508.3403928399223, 1499.98075034671, 1491.1634688362112, 1482.0796083333673, 1472.9251129440222, 1463.8996231960034, 1455.2032725120805, 1447.0309117219088, 1439.5633733594857, 1432.9558116896176, 1427.3239005107537, 1422.729693749635, 1419.1700063609585, 1416.570779920856, 1414.7905035789868, 1413.63407727538, 1412.8758537186466, 1412.2879130866945, 1411.667970478238, 1410.8612753091459, 1409.7723453049732, 1408.3648699645223, 1406.6509432705207, 1404.673177990871, 1402.4844753783448, 1400.1298954275696, 1397.6334620287641, 1394.9906392928776, 1392.165472215306, 1389.0904506595045, 1385.667003047561, 1381.764844981043, 1377.2188598426953, 1371.822551019453, 1365.3172903769234, 1357.3766218982498, 1347.5851193427568, 1335.4138266574685, 1320.2072849967758, 1301.23297401585, 1277.8648967600632, 1250.0071587436403, 1218.7169892007007, 1188.4740651725942, 1212.1217396420177, 1202.8642091224226, 1181.0800221291804, 1174.5548686589566, 1177.06617074557, 1177.1737186962923, 1173.748490358539, 1166.0395969341832, 1147.256434513142, 1131.0727426526971, 1149.1934006999397, 1134.6621621668173, 1122.7587378474127, 1125.8425124861653, 1128.8578672563483, 1117.8205958220797, 1109.5829780489971, 1106.2705977656822, 1104.393029227873, 1096.5605659483488, 1090.5507487324955, 1088.6298411905802, 1083.0580998671728, 1071.7268695841356, 1058.5871867552032, 1060.837804760779, 1045.3157837271792, 1042.7258735701732, 1035.5353109054727, 1025.746585120111, 1025.2167034391628, 1016.1615694676597, 1023.3859737751794, 1031.110640772327, 1029.721669694569, 1026.325155560533, 1025.4193613369812, 1018.637974153767, 1014.0575756052809, 1016.556577398415, 1017.6186569277065, 1017.8881156117665, 1017.8270196348894, 1018.970313742277, 1017.5924715124892, 1017.9358811044966, 1016.1801537869156, 1014.0214864612134, 1013.1508554964777, 1012.4897082685062]})
    check_mpkls(test_GMM,params_store,[0.0, 0.00022942331022557383, 0.00065849782513272, 0.0012577493548364682, 0.0020036395698388443, 0.0028844523252771204, 0.0039061014528369853, 0.005097590838421429, 0.006515743453741507, 0.008248575420026327, 0.010416353131524891, 0.01316897852701815, 0.016677987847406817, 0.021121290820669048, 0.0266590941956788, 0.03340061148303963, 0.041363508652638714, 0.05043164842887338, 0.06032098016413756, 0.07056677564368186, 0.080545360444084, 0.08953774585901231, 0.09683086532420848, 0.10183770273244175, 0.1042066843501297, 0.10388946185166037, 0.1011469316171445, 0.09775986979019824, 0.10683811388353837, 0.11646961082497898, 0.12688791601266947, 0.13842261089117236, 0.15151692296449326, 0.16675607966796435, 0.1849138400152377, 0.20702776338409157, 0.23451954482465487, 0.26938764408102944, 0.31452018046912844, 0.3742164060334241, 0.4550864668146155, 0.5676717711786832, 0.7580533931086171, 1.0593118478515477, 1.5389213713192804, 2.3546241004604553, 3.862328746847337, 6.9797992744094, 14.58393076698857, 39.35560551460964, 171.60763084077564, 147.69117154936654, 61.03323522275949, 30.014177456386264, 20.198284925832866, 19.004739839442173, 24.90970970006203, 40.43855534852633, 69.5134927846708, 120.16119618027558, 162.6053572080931, 112.25388122898579, 82.07238864431855, 82.33359327518978, 88.37558305583838, 84.21832257922327, 89.37520756177814, 124.94708962826738, 231.04796508133546, 262.44030761788747, 132.8262247227446, 85.8314176353328, 74.97583934088611, 87.88227977533904, 139.1328580370184, 224.70344871685367, 107.85453121954919, 72.46716309209836, 71.24421295459022, 97.3129266340971, 159.77086095244124, 153.96578077313393, 171.432292215588, 252.59044154292448, 311.47740669448854, 174.1024581490238, 131.24202566137438, 140.36749789277806, 196.20950742632883, 241.09418957839358, 185.7942134371872, 160.43576224987714, 171.05835769159216, 178.43981285864908, 147.82599578399723, 134.6625845158233, 147.34856808400986, 177.8239087113556, 187.67862021907823, 171.21401995601397])
    utils.check_labels(test_GMM,default_pinwheel_data,params_store,[2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2,
       1, 1, 2, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1,
       2, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1,
       1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 2, 1, 1, 1, 1, 1, 1, 1,
       2, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 1, 1, 2, 1, 1, 1,
       1, 2, 0, 0, 0, 0, 0, 0, 0, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0,
       0, 2, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0])

def test_gmm_different_optimizers_illustration():
    test_GMM, init_params = init_GMM()
    utils.check_fit(test_GMM,init_params,"grad_descent",{'learning_rate':0.0005,'mass':0.9,'maxiter':100,'tol':1e-7},
    100,{'likelihood':[-720.8092616186832, -719.9324989689964, -718.274814939572, -715.9300034638668, -712.9900481929888, -709.5458269817977, -705.6880453853835, -701.5082241387773, -697.0995833835279, -692.557653132106, -687.9804054374334, -683.467660563424, -679.1194852214626, -675.0333048263767, -671.2995356451652, -667.9957548102311, -665.1797992207992, -662.8826958402399, -661.1028521459016, -659.8032389258503, -658.9131007549157, -658.3348876031123, -657.9557758247456, -657.6618055087696, -657.3518342045413, -656.9484866199953, -656.4040216179089, -655.7002839476835, -654.8433206006827, -653.8544379608578, -652.7600866545947, -651.5827966792071, -650.3345799798044, -649.0131686118611, -647.6005850730753, -646.0630742951746, -644.3513504892028, -642.4002714559439, -640.12727888677, -637.4291244751488, -634.176494153884, -630.2061599145472, -625.3104086368007, -619.2247622941566, -611.6214914638102, -602.1343359733473, -590.4502973454539, -576.5214283372425, -560.8763435657727, -545.7548815517194, -557.5787187864312, -552.9499535266336, -542.0578600300125, -538.7952832949006, -540.0509343382073, -540.1047083135685, -538.3920941446918, -534.537647432514, -525.1460662219934, -517.0542202917709, -526.1145493153922, -518.848930048831, -512.8972178891287, -514.439105208505, -515.9467825935965, -510.42814687646216, -506.3093379899209, -504.6531478482634, -503.71436357935886, -499.79813193959666, -496.7932233316701, -495.8327695607124, -493.04689889900874, -487.3812837574901, -480.8114423430239, -481.9367513458118, -474.17574082901194, -472.88078575050895, -469.2855044181586, -464.3911415254778, -464.12620068500365, -459.5986336992521, -463.210835853012, -467.0731693515859, -466.3786838127068, -464.6804267456888, -464.2275296339129, -460.8368360423058, -458.54663676806274, -459.7961376646298, -460.32717742927554, -460.4619067713055, -460.431358782867, -461.00300583656076, -460.31408472166686, -460.4857895176706, -459.6079258588801, -458.52859219602897, -458.0932767136611, -457.7627030996754]})
    utils.check_fit(test_GMM,init_params,"rms_prop",{'learning_rate':0.01,'gamma':0.9,'maxiter':100,'tol':1e-7},
    100,{'likelihood':[-720.8092616186832, -708.7687436918704, -700.5695943512028, -694.1365026952342, -688.7992701317978, -684.2343094906564, -680.2509729901997, -676.7237794488501, -673.5643825913835, -670.7066298910551, -668.0968903183066, -665.6867120416828, -663.4258206923182, -661.2538140270026, -659.0896525495962, -656.8207660722843, -654.2999317201795, -651.3613111758623, -647.8531607362195, -643.6709453080133, -638.7843858447935, -633.2539663815364, -627.2221184965576, -620.8801549218978, -614.4636427271009, -608.2643929292243, -602.456019642049, -596.9081858274922, -591.4105651077605, -585.7508455931047, -579.2361200491389, -571.3005530174688, -564.172746845719, -559.9692342016918, -556.2317981360701, -553.6491026962565, -553.8285413730459, -552.2184716875328, -557.2588487668247, -547.2401457215634, -543.1012704582643, -539.7613659647706, -535.9350001310447, -526.6055944282431, -519.9014845307088, -511.54377855034903, -513.4639162326912, -509.82767840193964, -512.3255191762332, -504.224073724909, -504.29187660903483, -501.20729969127706, -501.6497568993433, -498.2365682124075, -498.47800749959475, -496.0523921119279, -496.38449344315444, -493.8953075935875, -492.8158147940428, -490.78558672392865, -490.28337738528785, -487.76422081768396, -486.97667153089697, -485.1723625268167, -484.3246990296156, -482.4365320679669, -481.28301371748523, -479.28180892614614, -478.19575290407084, -475.1192977087656, -474.64094933175693, -473.9496380890591, -468.4587864148398, -466.9083778340837, -470.16859622690964, -465.79742926522664, -463.8055226097058, -466.8128246220731, -461.1228830650363, -461.6831446305278, -460.92211967906724, -461.78505838955675, -462.6529256935787, -460.64811365169464, -457.6046942659898, -457.97159049560634, -459.6551459554208, -456.3190258793679, -453.9506344713802, -454.85750592095764, -455.17040148199067, -454.12465144274745, -455.05452438209403, -451.8960680865562, -450.89581443724035, -451.7649684301779, -453.5601368625517, -448.9279824698304, -447.11734346082903, -447.9957991089229]})
    utils.check_fit(test_GMM,init_params,"adam",{'learning_rate':0.1,'beta1':0.9,'beta2':0.99,'maxiter':100,'tol':1e-7},
    100,{'likelihood':[-720.8092616186832, -685.0765304238932, -662.6350166131663, -649.0726027318387, -631.6760439953944, -600.1727102280388, -630.9274646458698, -578.9238847231686, -562.1652766610531, -599.5333653984801, -576.6578614655705, -571.7616447184506, -572.1276897293139, -570.8580451771829, -568.4294465585933, -563.1954191409984, -547.1253907516922, -535.9863256854486, -547.0920329764779, -533.8007869184905, -541.2124368508863, -544.8956395110998, -542.4479327601296, -536.8051646725269, -526.1368045225913, -510.95425998897133, -543.444007802955, -512.152251552897, -527.9199129626833, -536.8015071095008, -540.6663066557124, -541.2374211534745, -540.1606872327426, -537.5056209828489, -532.1850042361264, -525.7223332383574, -518.8795230160448, -510.62421365418334, -501.8351501237513, -496.0947389901992, -495.5640417307013, -487.6062143093626, -480.1439506748476, -467.6072886581891, -456.8583335842601, -458.74280360225305, -452.065805759324, -450.5916944705273, -447.4315621902442, -452.51906725056193, -443.96241600572114, -418.29571475258524, -458.65764221757587, -427.1375216171984, -452.66611522384954, -455.26957952742555, -465.0815750309949, -468.6319205004013, -465.8171296835387, -460.23112811201173, -463.87108213970976, -459.2453319292692, -458.1554589293731, -447.7194289502818, -435.0182304604739, -421.794698101073, -404.49820759156694, -403.9870151408575, -411.4319290667946, -393.71379784340223, -392.1380672937601, -391.87888169954306, -388.5245212209089, -396.3818912961044, -387.4270975483545, -387.3284263319796, -392.9871951394679, -392.4858223638304, -386.7096338109598, -383.1931810073993, -382.7340802157262, -379.7125309531715, -377.3802602891027, -380.53367195456275, -383.2453285014234, -380.70035653047086, -376.6409811862652, -375.32687869138647, -376.4843475173675, -376.54856367032045, -377.15917069846955, -377.438651553289, -376.78536138407344, -376.2167976693082, -375.2600559251107, -375.38450087266824, -375.5945242898064, -375.1206656585679, -375.11894252792985, -375.12363420047484]})
    utils.check_fit(test_GMM,init_params,"Newton-CG",{'maxiter':100,'tol':1e-7},
    45,{'likelihood':[-686.1832497203505, -662.5130705607676, -582.3683234440672, -565.3490558739454, -559.751461045092, -556.7400049073358, -527.1685213755835, -510.3776376438325, -503.4966867345782, -491.3439022513371, -481.6544426206317, -468.53913023909973, -464.8290683167083, -461.5960466773456, -460.84108119533266, -459.6465663087923, -457.73995807964667, -456.81781746514054, -455.3388811402798, -453.83825711466204, -451.2754170989686, -447.63854843031527, -441.1096579931589, -429.56336516222257, -428.2180655857422, -426.9663179984793, -424.9075522708426, -422.9491878237513, -421.6719838738693, -406.9576970250804, -402.03876477324854, -392.95790899273015, -383.59676776727986, -378.81482720782014, -377.3320386262477, -377.0252510739965, -376.80791729452324, -376.5400478022773, -376.4227884652606, -376.4169895184245, -376.41611277291616, -376.4160326833853, -376.41600488853186, -376.416002297345, -376.41600169837943]})

def test_gmm_different_initializations_illustration():
    test_GMM, init_params = init_GMM()

    init_params['log proportions'] = np.log([0.1,0.2,0.7])
    from scipy.linalg import sqrtm
    init_params['sqrt_covs'][0] = sqrtm([[4,-0.75],[-0.75,1]])
    
    utils.check_fit(test_GMM,init_params,"grad_descent",{'learning_rate':0.0005,'mass':0.9,'maxiter':100,'tol':1e-7},
    100,{'likelihood':[-722.4161069308386, -721.1705366046116, -718.8246652036032, -715.5301044696275, -711.4471794030688, -706.7491006708485, -701.6268869728217, -696.2938895297725, -690.9882711143798, -685.9709407902037, -681.5154284034991, -677.8855644750274, -675.2978406413845, -673.86983452704, -673.565453423054, -674.1598789846466, -675.2534205513351, -676.3518710435865, -676.9982189288901, -676.904272079762, -676.0209669724117, -674.5169305331921, -672.6854863454755, -670.8326365146306, -669.193801825346, -667.8987744414289, -666.9776100087681, -666.3885341891557, -666.0505839797339, -665.8708594336701, -665.7629425840812, -665.657035942249, -665.5039190167115, -665.2749204911306, -664.9596169543219, -664.5623908722177, -664.0985170626386, -663.5901463938926, -663.0623996813019, -662.5397356710057, -662.0427729866942, -661.5857849488541, -661.1751063187493, -660.8086548686904, -660.4766557367022, -660.163468185709, -659.8501934031066, -659.5175572236267, -659.1484852654794, -658.7298614986703, -658.2531711361526, -657.7140073450695, -657.1106757657969, -656.4422839506485, -655.7067229558725, -654.8988541493201, -654.0090565627855, -653.0221245185489, -651.9163716597078, -650.6627126413737, -649.2234560253903, -647.550543015614, -645.5830046823612, -643.2435014752812, -640.4339908783684, -637.0308696772784, -632.8802189946978, -627.7932642903106, -621.5387267161336, -613.821903410686, -604.2525065064281, -592.4191152904286, -578.6092765062581, -564.7818003525969, -551.7068977416627, -539.2281382705164, -526.1107634680235, -508.57935790013426, -508.91504408729475, -526.9890187051262, -521.684327749204, -523.8644843568655, -525.0278286375308, -521.3739113752306, -512.2401524146428, -501.10896787941954, -499.6536567575751, -483.8840558489004, -484.84603609592455, -490.01586336267934, -490.0508059051898, -486.2662268524141, -479.6907611816478, -471.7187591331591, -478.26607147910636, -476.9159879187907, -477.26910949325935, -474.72516208811516, -477.14517414582707, -470.37803796394417]})
    